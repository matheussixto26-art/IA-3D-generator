<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <title>Jogo Mobile Simples</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      margin: 0;
      overflow: hidden;
      touch-action: none;
      background: #000;
      font-family: Arial, sans-serif;
    }
    canvas { display: block; }

    /* Bot√µes */
    #forward-btn, #jump-btn {
      position: fixed;
      bottom: 30px;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: 3px solid white;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      font-size: 18px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      pointer-events: auto;
      text-shadow: 0 0 6px black;
    }

    #forward-btn {
      left: 30px;
    }

    #jump-btn {
      right: 30px;
      background: rgba(0, 200, 255, 0.3);
      border-color: #0ff;
    }

    #info {
      position: fixed;
      top: 15px;
      width: 100%;
      text-align: center;
      color: white;
      font-size: 16px;
      text-shadow: 0 0 5px black;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="info">Conectando...</div>
  <div id="forward-btn">‚ñ∂Ô∏è Frente</div>
  <div id="jump-btn">‚¨ÜÔ∏è Pular</div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
    const socket = io();

    // Cena
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x1a1a2e);
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.body.appendChild(renderer.domElement);

    // Ch√£o (arena)
    const ground = new THREE.Mesh(
      new THREE.PlaneGeometry(200, 200),
      new THREE.MeshBasicMaterial({ color: 0x16213e, side: THREE.DoubleSide })
    );
    ground.rotation.x = Math.PI / 2;
    scene.add(ground);

    // Luz
    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
    dirLight.position.set(10, 20, 10);
    scene.add(dirLight);

    // Jogadores
    const players = {};
    const colors = [0xff6b6b, 0x4cc9f0];
    let myId = null;
    let isJumping = false;
    let jumpVelocity = 0;
    const gravity = 0.025;
    const jumpStrength = 0.35;

    function createPlayer(id, x = 0, y = 1, z = 0) {
      const cube = new THREE.Mesh(
        new THREE.BoxGeometry(1, 1, 1),
        new THREE.MeshLambertMaterial({ color: colors[Object.keys(players).length % 2] })
      );
      cube.position.set(x, y, z);
      scene.add(cube);
      players[id] = { mesh: cube };
    }

    // Controles
    let moveForward = false;
    let jumpPressed = false;

    function setupButton(id, action) {
      const btn = document.getElementById(id);
      const down = () => action(true);
      const up = () => action(false);
      btn.addEventListener('pointerdown', down);
      btn.addEventListener('pointerup', up);
      btn.addEventListener('pointerleave', up);
      // Mobile fallback
      btn.addEventListener('touchstart', (e) => { e.preventDefault(); down(); });
      btn.addEventListener('touchend', up);
    }

    setupButton('forward-btn', (val) => moveForward = val);
    setupButton('jump-btn', (val) => jumpPressed = val);

    // Conex√£o com servidor
    socket.on('init', (data) => {
      myId = data.id;
      document.getElementById('info').textContent = 'üü¢ Conectado! Toque nos bot√µes para jogar.';
      data.players.forEach(p => {
        if (!players[p.id]) createPlayer(p.id, p.x, p.y, p.z);
      });
    });

    socket.on('newPlayer', (p) => {
      if (!players[p.id]) createPlayer(p.id, p.x, p.y, p.z);
    });

    socket.on('removePlayer', (id) => {
      if (players[id]) {
        scene.remove(players[id].mesh);
        delete players[id];
      }
    });

    socket.on('updatePositions', (allPlayers) => {
      allPlayers.forEach(p => {
        if (players[p.id] && p.id !== myId) {
          players[p.id].mesh.position.set(p.x, p.y, p.z);
        }
      });
    });

    // Loop principal
    const moveSpeed = 0.15;
    camera.position.set(0, 12, 20);
    camera.lookAt(0, 0, 0);

    function animate() {
      requestAnimationFrame(animate);

      if (myId && players[myId]) {
        const pos = players[myId].mesh.position;

        // Pulo
        if (jumpPressed && !isJumping && pos.y <= 1.1) {
          isJumping = true;
          jumpVelocity = jumpStrength;
        }

        if (isJumping) {
          pos.y += jumpVelocity;
          jumpVelocity -= gravity;
          if (pos.y <= 1) {
            pos.y = 1;
            isJumping = false;
            jumpVelocity = 0;
          }
        }

        // Frente
        if (moveForward) {
          pos.z -= moveSpeed;
        }

        // Limites da arena
        pos.x = Math.max(-95, Math.min(95, pos.x));
        pos.z = Math.max(-95, Math.min(95, pos.z));

        // Enviar posi√ß√£o
        socket.emit('move', { x: pos.x, y: pos.y, z: pos.z });
      }

      renderer.render(scene, camera);
    }
    animate();

    // Ajuste de tela
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
